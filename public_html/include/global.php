<?

function get_user_timezone($id) {
    /* празно */
}

$smilies = array(
    ":-)" => "smile1.gif",
    ":smile:" => "smile2.gif",
    ":-D" => "grin.gif",
    ":lol:" => "laugh.gif",
    ":w00t:" => "w00t.gif",
    ":-P" => "tongue.gif",
    ";-)" => "wink.gif",
    ":-|" => "noexpression.gif",
    ":-/" => "confused.gif",
    ":-(" => "sad.gif",
    ":'-(" => "cry.gif",
    ":weep:" => "weep.gif",
    ":-O" => "ohmy.gif",
    ":o)" => "clown.gif",
    "8-)" => "cool1.gif",
    "|-)" => "sleeping.gif",
    ":innocent:" => "innocent.gif",
    ":whistle:" => "whistle.gif",
    ":unsure:" => "unsure.gif",
    ":closedeyes:" => "closedeyes.gif",
    ":cool:" => "cool2.gif",
    ":fun:" => "fun.gif",
    ":thumbsup:" => "thumbsup.gif",
    ":thumbsdown:" => "thumbsdown.gif",
    ":blush:" => "blush.gif",
    ":unsure:" => "unsure.gif",
    ":yes:" => "yes.gif",
    ":no:" => "no.gif",
    ":love:" => "love.gif",
    ":?:" => "question.gif",
    ":!:" => "excl.gif",
    ":idea:" => "idea.gif",
    ":arrow:" => "arrow.gif",
    ":arrow2:" => "arrow2.gif",
    ":hmm:" => "hmm.gif",
    ":hmmm:" => "hmmm.gif",
    ":huh:" => "huh.gif",
    ":geek:" => "geek.gif",
    ":look:" => "look.gif",
    ":rolleyes:" => "rolleyes.gif",
    ":kiss:" => "kiss.gif",
    ":shifty:" => "shifty.gif",
    ":blink:" => "blink.gif",
    ":smartass:" => "smartass.gif",
    ":sick:" => "sick.gif",
    ":crazy:" => "crazy.gif",
    ":wacko:" => "wacko.gif",
    ":alien:" => "alien.gif",
    ":wizard:" => "wizard.gif",
    ":wave:" => "wave.gif",
    ":wavecry:" => "wavecry.gif",
    ":baby:" => "baby.gif",
    ":angry:" => "angry.gif",
    ":ras:" => "ras.gif",
    ":sly:" => "sly.gif",
    ":devil:" => "devil.gif",
    ":evil:" => "evil.gif",
    ":evilmad:" => "evilmad.gif",
    ":sneaky:" => "sneaky.gif",
    ":axe:" => "axe.gif",
    ":slap:" => "slap.gif",
    ":wall:" => "wall.gif",
    ":rant:" => "rant.gif",
    ":jump:" => "jump.gif",
    ":yucky:" => "yucky.gif",
    ":nugget:" => "nugget.gif",
    ":smart:" => "smart.gif",
    ":shutup:" => "shutup.gif",
    ":shutup2:" => "shutup2.gif",
    ":crockett:" => "crockett.gif",
    ":zorro:" => "zorro.gif",
    ":snap:" => "snap.gif",
    ":beer:" => "beer.gif",
    ":beer2:" => "beer2.gif",
    ":drunk:" => "drunk.gif",
    ":strongbench:" => "strongbench.gif",
    ":weakbench:" => "weakbench.gif",
    ":dumbells:" => "dumbells.gif",
    ":music:" => "music.gif",
    ":stupid:" => "stupid.gif",
    ":dots:" => "dots.gif",
    ":offtopic:" => "offtopic.gif",
    ":spam:" => "spam.gif",
    ":oops:" => "oops.gif",
    ":lttd:" => "lttd.gif",
    ":please:" => "please.gif",
    ":sorry:" => "sorry.gif",
    ":hi:" => "hi.gif",
    ":yay:" => "yay.gif",
    ":cake:" => "cake.gif",
    ":hbd:" => "hbd.gif",
    ":band:" => "band.gif",
    ":punk:" => "punk.gif",
    ":rofl:" => "rofl.gif",
    ":bounce:" => "bounce.gif",
    ":mbounce:" => "mbounce.gif",
    ":thankyou:" => "thankyou.gif",
    ":gathering:" => "gathering.gif",
    ":hang:" => "hang.gif",
    ":chop:" => "chop.gif",
    ":rip:" => "rip.gif",
    ":whip:" => "whip.gif",
    ":judge:" => "judge.gif",
    ":chair:" => "chair.gif",
    ":tease:" => "tease.gif",
    ":box:" => "box.gif",
    ":boxing:" => "boxing.gif",
    ":guns:" => "guns.gif",
    ":shoot:" => "shoot.gif",
    ":shoot2:" => "shoot2.gif",
    ":flowers:" => "flowers.gif",
    ":wub:" => "wub.gif",
    ":lovers:" => "lovers.gif",
    ":kissing:" => "kissing.gif",
    ":kissing2:" => "kissing2.gif",
    ":console:" => "console.gif",
    ":group:" => "group.gif",
    ":hump:" => "hump.gif",
    ":hooray:" => "hooray.gif",
    ":happy2:" => "happy2.gif",
    ":clap:" => "clap.gif",
    ":clap2:" => "clap2.gif",
    ":weirdo:" => "weirdo.gif",
    ":yawn:" => "yawn.gif",
    ":bow:" => "bow.gif",
    ":dawgie:" => "dawgie.gif",
    ":cylon:" => "cylon.gif",
    ":book:" => "book.gif",
    ":fish:" => "fish.gif",
    ":mama:" => "mama.gif",
    ":pepsi:" => "pepsi.gif",
    ":medieval:" => "medieval.gif",
    ":rambo:" => "rambo.gif",
    ":ninja:" => "ninja.gif",
    ":hannibal:" => "hannibal.gif",
    ":party:" => "party.gif",
    ":snorkle:" => "snorkle.gif",
    ":evo:" => "evo.gif",
    ":king:" => "king.gif",
    ":chef:" => "chef.gif",
    ":mario:" => "mario.gif",
    ":pope:" => "pope.gif",
    ":fez:" => "fez.gif",
    ":cap:" => "cap.gif",
    ":cowboy:" => "cowboy.gif",
    ":pirate:" => "pirate.gif",
    ":pirate2:" => "pirate2.gif",
    ":rock:" => "rock.gif",
    ":cigar:" => "cigar.gif",
    ":icecream:" => "icecream.gif",
    ":oldtimer:" => "oldtimer.gif",
    ":trampoline:" => "trampoline.gif",
    ":banana:" => "bananadance.gif",
    ":smurf:" => "smurf.gif",
    ":yikes:" => "yikes.gif",
    ":osama:" => "osama.gif",
    ":saddam:" => "saddam.gif",
    ":santa:" => "santa.gif",
    ":indian:" => "indian.gif",
    ":pimp:" => "pimp.gif",
    ":nuke:" => "nuke.gif",
    ":jacko:" => "jacko.gif",
    ":ike:" => "ike.gif",
    ":greedy:" => "greedy.gif",
    ":super:" => "super.gif",
    ":wolverine:" => "wolverine.gif",
    ":spidey:" => "spidey.gif",
    ":spider:" => "spider.gif",
    ":bandana:" => "bandana.gif",
    ":construction:" => "construction.gif",
    ":sheep:" => "sheep.gif",
    ":police:" => "police.gif",
    ":detective:" => "detective.gif",
    ":bike:" => "bike.gif",
    ":fishing:" => "fishing.gif",
    ":clover:" => "clover.gif",
    ":horse:" => "horse.gif",
    ":shit:" => "shit.gif",
    ":soldiers:" => "soldiers.gif",
);

$privatesmilies = array(
    ":)" => "smile1.gif",
    ":wink:" => "wink.gif",
    ":D" => "grin.gif",
    ":P" => "tongue.gif",
    ":(" => "sad.gif",
    ":'(" => "cry.gif",
    ":|" => "noexpression.gif",
    ":Boozer:" => "alcoholic.gif",
    ":deadhorse:" => "deadhorse.gif",
    ":spank:" => "spank.gif",
    ":yoji:" => "yoji.gif",
    ":locked:" => "locked.gif",
    ":grrr:" => "angry.gif",
    "O:-" => "innocent.gif",
    ":sleeping:" => "sleeping.gif",
    "-_-" => "unsure.gif",
    ":clown:" => "clown.gif",
    ":mml:" => "mml.gif",
    ":rtf:" => "rtf.gif",
    ":morepics:" => "morepics.gif",
    ":rb:" => "rb.gif",
    ":rblocked:" => "rblocked.gif",
    ":maxlocked:" => "maxlocked.gif",
    ":hslocked:" => "hslocked.gif",
);

$linebreak = "\r\n";

function get_row_count($table, $suffix = "") {
    if ($suffix)
        $suffix = " $suffix";
    ($r = mysql_query("SELECT COUNT(*) FROM $table$suffix")) or die(mysql_error());
    ($a = mysql_fetch_row($r)) or die(mysql_error());
    return $a[0];
}

function stdmsg($heading, $text) {
    print("<div class=blog_part_left_box><div class=gamepad_ico></div><div class=blog_part_left_smallheader>\n");
    if ($heading)
        print("<font size=5>$heading</font></div>\n");
    print("<div class=error><center><font size=3>\n");
    print($text . "<br/><u><a Type=range onClick=history.go(-1);return true;>Върнете се обратно.</a></u></font></center></div></div>\n");
}

function stderr($heading, $text) {
    stdhead();
    stdmsg($heading, $text);
    stdfoot();
    die;
}

function sqlerr($file = '', $line = '') {
    print("<table border=0 bgcolor=blue align=left cellspacing=0 cellpadding=10 style='background: blue'>" .
            "<tr><td class=embedded><font color=white><h1>SQL Грешка</h1>\n" .
            "<b>" . mysql_error() . ($file != '' && $line != '' ? "<p>файл - $file ; ред - $line</p>" : "") . "</b></font></td></tr></table>");
    die;
}

function get_date_time($timestamp = 0) {
    if ($timestamp)
        return date("Y-m-d H:i:s", $timestamp);
    else
        $idcookie = $_COOKIE['uid'];
    return gmdate("Y-m-d H:i:s", time() + (60 * get_user_timezone($idcookie)));
}

function encodehtml($s, $linebreaks = true) {
    $s = str_replace("<", "&lt;", str_replace("&", "&amp;", $s));
    if ($linebreaks)
        $s = nl2br($s);
    return $s;
}

function get_dt_num() {
    return gmdate("YmdHis");
}

function format_urls($s) {
    return preg_replace(
                    "/(\A|[^=\]'\"a-zA-Z0-9])((http|ftp|https|ftps|irc):\/\/[^()<>\s]+)/i", "\\1<a href=\"\\2\">\\2</a>", $s);
}

function _strlastpos($haystack, $needle, $offset = 0) {
    $addLen = strlen($needle);
    $endPos = $offset - $addLen;
    while (true) {
        if (($newPos = strpos($haystack, $needle, $endPos + $addLen)) === false)
            break;
        $endPos = $newPos;
    }
    return ($endPos >= 0) ? $endPos : false;
}

//бб кодове
function format_comment($text, $strip_html = true) {
    global $smilies, $privatesmilies;

    $s = $text;

    $s = str_replace(";)", ":wink:", $s);

    if ($strip_html)
        $s = htmlspecialchars($s);

    // [b]удебелен Текст[/b]
    $s = preg_replace("/\[b\]((\s|.)+?)\[\/b\]/", "<b>\\1</b>", $s);

    // [i]курсивен Текст[/i]
    $s = preg_replace("/\[i\]((\s|.)+?)\[\/i\]/", "<i>\\1</i>", $s);

    // [u]подчертаване на Текст[/u]
    $s = preg_replace("/\[u\]((\s|.)+?)\[\/u\]/i", "<u>\\1</u>", $s);
	
    // [center]удебелен Текст[/center]
    $s = preg_replace("/\[center\]((\s|.)+?)\[\/center\]/", "<center>\\1</center>", $s);
	
    // [table]Текст[/teble]
    $s = preg_replace("/\[table\]((\s|.)+?)\[\/table\]/", "<div class=bbtable><table border=1 width=100% border=1 cellspacing=0 cellpadding=5>\\1</table>", $s);
	
    // [tr]Текст[/tr]
    $s = preg_replace("/\[tr\]((\s|.)+?)\[\/tr\]/", "<tr>\\1</tr>", $s);
	
    // [td]Текст[/td]
    $s = preg_replace("/\[td\]((\s|.)+?)\[\/td\]/", "<td>\\1</td>", $s);
	
    // [img]линк към картинка[/img]
    $s = preg_replace("/\[img\]([^\s'\"<>]+?)\[\/img\]/i", "<img src=\"\\1\">", $s);


    // [color=blue]Текст[/color]
    $s = preg_replace(
            "/\[color=blue\]((\s|.)+?)\[\/color\]/i", "<font color=blue>\\1</font>", $s);

    // [color=red]Текст[/color]
    $s = preg_replace(
            "/\[color=red\]((\s|.)+?)\[\/color\]/i", "<font color=red>\\1</font>", $s);
			
    // [color=green]Текст[/color]
    $s = preg_replace(
            "/\[color=green\]((\s|.)+?)\[\/color\]/i", "<font color=green>\\1</font>", $s);

    // [url=някакъв линк]Текст[/url]
    $s = preg_replace(
            "/\[url=([^()<>\s]+?)\]((\s|.)+?)\[\/url\]/i", "<a href=\"\\1\">\\2</a>", $s);

    // [url]някакъв линк[/url]
    $s = preg_replace(
            "/\[url\]([^()<>\s]+?)\[\/url\]/i", "<a href=\"\\1\">\\1</a>", $s);

    // [size=4]Текст[/size]
    $s = preg_replace(
            "/\[size=([1-7])\]((\s|.)+?)\[\/size\]/i", "<font size=\\1>\\2</font>", $s);

    // [font=Arial]Текст[/font]
    $s = preg_replace(
            "/\[font=([a-zA-Z ,]+)\]((\s|.)+?)\[\/font\]/i", "<font face=\"\\1\">\\2</font>", $s);

    // линкове
    $s = format_urls($s);

    // слагане на нов ред
    $s = nl2br($s);

    // слагане на разстояния
    $s = str_replace("  ", " &nbsp;", $s);

    reset($smilies);
    while (list($code, $url) = each($smilies))
        $s = str_replace($code, "<img border=0 src=\"pic/smilies/$url\" alt=\"" . htmlspecialchars($code) . "\">", $s);

    reset($privatesmilies);
    while (list($code, $url) = each($privatesmilies))
        $s = str_replace($code, "<img border=0 src=\"pic/smilies/$url\">", $s);

    return $s;
}

define("UC_USER", 1);
define("UC_VIP", 2);
define("UC_MOD", 3);
define("UC_ADMIN", 4);

function get_user_class() {
    global $CURUSER;
    return $CURUSER["class"];
}

function get_user_class_name($class) {
    switch ($class) {
        case UC_USER: return "Потребител";

        case UC_VIP: return "VIP";

        case UC_MOD: return "Модератор";

        case UC_ADMIN: return "Администратор";
    }
    return "";
}

// валиден ранг
function is_valid_user_class($class) {
    return is_numeric($class) && floor($class) == $class && $class >= UC_USER && $class <= UC_ADMIN;
}

// валидно ИП
function is_valid_id($id) {
    return is_numeric($id) && ($id > 0) && (floor($id) == $id);
}

// започване на главна таблица
function begin_main_frame() {
    print("<table class=main width=100% border=0 cellspacing=0 cellpadding=0>" .
            "<tr><td class=embedded>\n");
}

// завършване на главна таблица
function end_main_frame() {
    print("</td></tr></table>\n");
}

function begin_frame($caption = "", $center = false, $padding = 10) {
    if ($caption)
        print("<h2>$caption</h2>\n");

    if ($center)
        $tdextra .= " align=center";

    print("<table width=100% border=1 cellspacing=0 cellpadding=$padding><tr><td$tdextra>\n");
}

function attach_frame($padding = 10) {
    print("</td></tr><tr><td style='border-top: 0px'>\n");
}

function end_frame() {
    print("</td></tr></table>\n");
}

function begin_block($caption = "-", $alignit = "left") {
    ?><h2 class=block>&nbsp;<font face="tahoma" size="2">&raquo;</font>&nbsp;<?= $caption ?></h2><div class=bodydiv style="text-align:<?= $alignit ?>;"><?php
}

function end_block() {
    ?></div><?php
    }

    function begin_table($fullwidth = false, $padding = 5) {
        if ($fullwidth)
            $width = " width=100%";
        print("<table class=main$width border=1 cellspacing=0 cellpadding=$padding>\n");
    }

    function end_table() {
        print("</td></tr></table>\n");
    }

    function insert_smilies_frame() {
        global $smilies, $BASEURL;

        begin_frame("Енитикони", true);

        begin_table(false, 5);

        print("<tr><td class=colhead>Напиши...</td><td class=colhead>За да получиш...</td></tr>\n");

        while (list($code, $url) = each($smilies))
            print("<tr><td>$code</td><td><img src=$DEFAULTBASEURL/pic/smilies/$url></td>\n");

        end_table();

        end_frame();
    }

    function sql_timestamp_to_unix_timestamp($s) {
        return mktime(substr($s, 11, 2), substr($s, 14, 2), substr($s, 17, 2), substr($s, 5, 2), substr($s, 8, 2), substr($s, 0, 4));
    }

    function write_log($text) {
        $text = sqlesc($text);
        $added = sqlesc(get_date_time());
        mysql_query("INSERT INTO sitelog (added, txt) VALUES($added, $text)") or sqlerr(__FILE__, __LINE__);
    }

    function get_elapsed_time($ts) {
        $mins = floor((gmtime() - $ts) / 60);
        $hours = floor($mins / 60);
        $mins -= $hours * 60;
        $days = floor($hours / 24);
        $hours -= $days * 24;
        $weeks = floor($days / 7);
        $days -= $weeks * 7;
        $t = "";
        if ($weeks > 0)
            return "$weeks&nbsp;" . ($weeks > 1 ? "седмици" : "седмица");
        if ($days > 0)
            return "$days&nbsp;" . ($days > 1 ? "дена" : "ден");
        if ($hours > 0)
            return "$hours&nbsp;" . ($hours > 1 ? "часа" : "час");
        if ($mins > 0)
            return "$mins&nbsp;" . ($mins > 1 ? "минути" : "минута");
        return "няма и минута";
    }
?>
